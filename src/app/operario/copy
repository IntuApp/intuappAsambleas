"use client";

import { useState, useEffect, useCallback, useMemo } from "react";
import { useParams, useRouter } from "next/navigation";
import { toast } from "react-toastify";

import {
  getEntityById,
  getAssemblyRegistriesList,
  updateEntity,
  deleteEntity,
} from "@/lib/entities";
import { getEntityTypes } from "@/lib/masterData";
import { colombiaCities } from "@/lib/colombiaCities";
import { getAssemblyById } from "@/lib/assembly";

import Loader from "@/components/basics/Loader";
import CustomText from "@/components/basics/CustomText";
import CustomButton from "@/components/basics/CustomButton";
import CustomIcon from "@/components/basics/CustomIcon";

import EntityDatabaseManager from "@/components/entities/EntityDatabaseManager";
import AssemblySearchBar from "@/components/searchBar/AssemblySearch";
import EntityEditModal from "@/components/entities/EntityEditModal";

import { ICON_PATHS } from "@/app/constans/iconPaths";
import { getIconPath } from "@/lib/utils";

import { Users, Video, Save, X } from "lucide-react";
import { usePageTitle } from "@/context/PageTitleContext";

const EntityDetailPage = () => {
  const { entityId } = useParams();
  const router = useRouter();
  const { setSegmentTitle } = usePageTitle();

  const [loading, setLoading] = useState(true);
  const [entityData, setEntityData] = useState(null);
  const [assemblies, setAssemblies] = useState([]);
  const [registries, setRegistries] = useState([]);
  const [entityTypes, setEntityTypes] = useState([]);
  const [assemblySearchTerm, setAssemblySearchTerm] = useState("");
  const [assemblyTypeFilter, setAssemblyTypeFilter] = useState("");
  const [assemblyStatusFilter, setAssemblyStatusFilter] = useState("");
  const [assemblySort, setAssemblySort] = useState("name");

  const [isEditModalOpen, setIsEditModalOpen] = useState(false);

  const [formData, setFormData] = useState({
    name: "",
    nit: "",
    type: "",
    city: "",
    address: "",
  });

    if (assemblySort === "name-asc") {
      result.sort((a, b) => a.name.localeCompare(b.name));
    }

    if (assemblySort === "name-desc") {
      result.sort((a, b) => b.name.localeCompare(a.name));
    }

    if (assemblySort === "recent") {
      result.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    }

    const filteredAssemblies = useMemo(() => {
    let result = [...assemblies];

    if (assemblySearchTerm) {
      result = result.filter((a) =>
        a.name?.toLowerCase().includes(assemblySearchTerm.toLowerCase()),
      );
    }

    if (assemblyTypeFilter) {
      result = result.filter((a) => a.type === assemblyTypeFilter);
    }

    if (assemblyStatusFilter) {
      result = result.filter((a) => a.status === assemblyStatusFilter);
    }

    if (assemblySort === "name-asc") {
      result.sort((a, b) => a.name.localeCompare(b.name));
    }

    if (assemblySort === "name-desc") {
      result.sort((a, b) => b.name.localeCompare(a.name));
    }

    if (assemblySort === "recent") {
      result.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    }

    return result;
  }, [
    assemblies,
    assemblySearchTerm,
    assemblyTypeFilter,
    assemblyStatusFilter,
    assemblySort,
  ]);


  /* ---------------- FETCH DATA ---------------- */

  const fetchEntityData = useCallback(async () => {
    if (!entityId) return;

    const res = await getEntityById(entityId);

    if (!res.success) {
      toast.error("Error cargando entidad");
      router.push("/operario/entidades");
      return;
    }

    const data = res.data;
    setEntityData(data);
    setSegmentTitle(entityId, data.name);

    setFormData({
      name: data.name || "",
      nit: data.nit || "",
      type: data.type || "",
      city: data.city || "",
      address: data.address || "",
    });

    if (data.assemblyRegistriesListId) {
      const resList = await getAssemblyRegistriesList(
        data.assemblyRegistriesListId,
      );
      if (resList.success) {
        setRegistries(Object.values(resList.data));
      }
    }

    if (Array.isArray(data.lastUpdateOwners)) {
      const results = await Promise.all(
        data.lastUpdateOwners.map((id) => getAssemblyById(id)),
      );
      setAssemblies(results.filter((r) => r.success).map((r) => r.data));
    }

    setLoading(false);
  }, [entityId, router, setSegmentTitle]);

  const fetchEntityTypes = async () => {
    const res = await getEntityTypes();
    if (res.success) setEntityTypes(res.data);
  };

  useEffect(() => {
    fetchEntityData();
    fetchEntityTypes();
  }, [fetchEntityData]);

  /* ---------------- ACTIONS ---------------- */

  const handleSaveEntity = async () => {
    setLoading(true);
    const res = await updateEntity(entityId, formData);

    if (res.success) {
      toast.success("Entidad actualizada correctamente");
      setIsEditModalOpen(false);
      fetchEntityData();
    } else {
      toast.error("Error al actualizar entidad");
    }
    setLoading(false);
  };

  const handleDeleteEntity = async () => {
    if (!confirm("¿Eliminar esta entidad? Esta acción no se puede deshacer."))
      return;

    setLoading(true);
    const res = await deleteEntity(entityId);

    if (res.success) {
      toast.success("Entidad eliminada correctamente");
      router.push("/operario/entidades");
    } else {
      toast.error("Error al eliminar entidad");
      setLoading(false);
    }
  };

  /* ---------------- HELPERS ---------------- */

  const getTypeNameInSpanish = (type) => {
    const map = {
      Residential: "Residencial",
      Commercial: "Comercial",
      Mixed: "Mixto",
      "Horizontal Property": "Propiedad Horizontal",
    };
    return map[type] || type;
  };

  const getTypeLabel = (typeId) => {
    const t = entityTypes.find((t) => t.id === typeId);
    return getTypeNameInSpanish(t?.name || typeId);
  };

  /* ---------------- FILTER ASSEMBLIES ---------------- */

  const filteredAssemblies = useMemo(() => {
    return [...assemblies].sort((a, b) => a.name.localeCompare(b.name));
  }, [assemblies]);

  if (loading) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-zinc-50">
        <Loader />
      </div>
    );
  }

  if (!entityData) return null;

  /* ---------------- RENDER ---------------- */

  return (
    <div className="flex w-full max-w-[1128px] flex-col gap-8 ">
      {/* MODAL EDIT */}
      
    </div>
  );
};

const Info = ({ label, value, icon }) => (
  <div className="flex flex-col gap-1">
    <CustomText variant="labelM" className="text-gray-500">
      {label}
    </CustomText>
    <div className="flex items-center gap-2 font-bold">
      {icon}
      {value || "-"}
    </div>
  </div>
);

export default EntityDetailPage;
